@model PumpDb.Marker

@{
    ViewBag.Title = "Подробная информация по объекту";
    Layout = "~/Views/Shared/MainLayout.cshtml";
}

@section Css
{
    <link rel="stylesheet" href="~/css/detail.css"/>

}

<script src='@Url.Content("~/js/moment-with-locales.min.js")'></script>



@Html.Partial("topmenu")



<div class="container" style="margin-top: 65px; margin-bottom:35px" data-ng-app="unicom" data-ng-controller="UnicomController" data-ng-init="init('@Model.Identity')">
    
    <alert data-ng-show="isAlarm(2).show" cls="{{isAlarm(2).cls}}" msg="{{isAlarm(2).message}}"></alert>

    <div class="row">
        <div class="col-lg-12 col-md-12 col-sm-12">
            <h2 class="text-primary text-center" style="margin-top: 5px">@Model.Address.ToString()</h2>
            <span class="pull-right">данные обновлены: <span class="text-success">{{updatedTime.toLocaleString('ru-RU',{day:'numeric', month:'long', year:'numeric', hour:'numeric', minute:'numeric', second:'numeric', timeZone:'Europe/Minsk'})}}</span></span>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12" >
            <div style="font-size: 18px; padding: 5px">
                <span class="text-muted" >последние полученые показания от</span>
                <span id="date_recv" class="text-primary" >{{lastData().RecvDate.toLocaleString('ru-RU',{day:'numeric', month:'long', year:'numeric', hour:'numeric', minute:'numeric', second:'numeric', timeZone:'Europe/Minsk'})}}</span>
            </div>
        </div>
          
            
       
    </div>
    <div class="row well well_view">
        <div class="col-lg-2 col-md-2 col-sm-3 col-xs-4 col">
            <div class="panel panel-info panelparam">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-xs-3 col-small">
                            <img src='@Url.Content("~/img/params_icon/tok.gif")' style="position: absolute; width: 85px"/>
                        </div>
                        <div class="col-xs-9 col-small text-right">
                            <span class="huge">{{lastData().Amperage1.toFixed(3)}}</span>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <span class="text-muted">Ток<sub>1</sub>, А</span>
                    <div class="clearfix"></div>
                </div>
                        
            </div>
        </div>
        <div class="col-lg-2 col-md-2 col-sm-3 col-xs-4 col">
            <div class="panel panel-info panelparam">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-xs-3 col-small">
                            <img src='@Url.Content("~/img/params_icon/tok.gif")' style="position: absolute; width: 85px"/>
                        </div>
                        <div class="col-xs-9 col-small text-right">
                            <span class="huge">{{lastData().Amperage2.toFixed(3)}}</span>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <span class="text-muted">Ток<sub>2</sub>, А</span>
                    <div class="clearfix"></div>
                </div>
                        
            </div>
        </div>
        <div class="col-lg-2 col-md-2 col-sm-3 col-xs-4 col">
            <div class="panel panel-info panelparam">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-xs-3 col-small">
                           <img src='@Url.Content("~/img/params_icon/tok.gif")' style="position: absolute; width: 85px"/>
                        </div>
                        <div class="col-xs-9 col-small text-right">
                            <span class="huge">{{lastData().Amperage3.toFixed(3)}}</span>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <span class="text-muted">Ток<sub>3</sub>, А</span>
                    <div class="clearfix"></div>
                </div>
                        
            </div>
        </div>

        <div class="col-lg-2 col-md-2 col-sm-3 col-xs-4 col">
            <div class="panel panel-warning panelparam">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-xs-3 col-small">
                            <img src='@Url.Content("~/img/params_icon/napr.gif")' style="position: absolute; width: 85px"/>
                        </div>
                        <div class="col-xs-9 col-small text-right">
                            <div class="huge">{{lastData().Voltage1.toFixed(1)}}</div>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <span class="text-muted">Напряжение<sub>1</sub>, В</span>
                    
                    <div class="clearfix"></div>
                </div>
                        
            </div>
        </div>
        
        <div class="col-lg-2 col-md-2 col-sm-3 col-xs-4 col">
            <div class="panel panel-warning panelparam">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-xs-3 col-small">
                             <img src='@Url.Content("~/img/params_icon/napr.gif")' style="position: absolute; width: 85px"/>
                        </div>
                        <div class="col-xs-9 col-small text-right">
                            <div class="huge">{{lastData().Voltage2.toFixed(1)}}</div>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <span class="text-muted">Напряжение<sub>2</sub>, В</span>
                    
                    <div class="clearfix"></div>
                </div>
                        
            </div>
        </div>
        
        <div class="col-lg-2 col-md-2 col-sm-3 col-xs-4 col">
            <div class="panel panel-warning panelparam">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-xs-3 col-small">
                             <img src='@Url.Content("~/img/params_icon/napr.gif")' style="position: absolute; width: 85px"/>
                        </div>
                        <div class="col-xs-9 col-small text-right">
                            <div class="huge">{{lastData().Voltage3.toFixed(1)}}</div>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <span class="text-muted">Напряжение<sub>3</sub>, В</span>
                    
                    <div class="clearfix"></div>
                </div>
                        
            </div>
        </div>

        <div class="col-lg-2 col-md-2 col-sm-3 col-xs-4 col">
            <div class="panel panel-warning panelparam">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-xs-3 col-small">
                            <img src='@Url.Content("~/img/params_icon/freq.gif")' style="position: absolute; height: 25px"/>
                        </div>
                        <div class="col-xs-9 col-small text-right">
                            <div class="huge">{{lastData().Frequrency.toFixed(1)}}</div>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <span class="text-muted">Частота, Гц</span>
                    <div class="clearfix"></div>
                </div>

            </div>
        </div>

        <div class="col-lg-2 col-md-2 col-sm-3 col-xs-4 col">
            <div class="panel panel-default panelparam">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-xs-3 col-small">
                            <img src='@Url.Content("~/img/params_icon/energ.gif")' style="position: absolute; height: 25px"/>
                        </div>
                        <div class="col-xs-9 col-small text-right">
                            <div class="huge">{{lastData().TotalEnergy.toFixed(3)}}</div>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <span class="text-muted">Эл. энергия, кВтч</span>
                    <div class="clearfix"></div>
                </div>
                        
            </div>
        </div>

        <div class="col-lg-2 col-md-2 col-sm-3 col-xs-4 col">
            <div class="panel panel-danger panelparam">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-xs-3 col-small">
                            <img src='@Url.Content("~/img/params_icon/termo.png")' style="position: absolute; height: 25px"/>
                        </div>
                        <div class="col-xs-9 col-small text-right">
                            <div class="huge">{{lastData().Temperature.toFixed(1)}}</div>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <span class="text-muted">Темп. IGBT, °C</span>
                    <div class="clearfix"></div>
                </div>

            </div>
        </div>

        
        <div class="col-lg-2 col-md-2 col-sm-3 col-xs-4 col">
            <div class="panel panel-danger panelparam">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-xs-3 col-small">
                            <img src='@Url.Content("~/img/params_icon/power.gif")' style="position: absolute; height: 25px"/>
                        </div>
                        <div class="col-xs-9 col-small text-right">
                            <div class="huge">{{lastData().CurrentElectricPower.toFixed(2)}}</div>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <span class="text-muted">Мощность, кВт</span>
                    
                    <div class="clearfix"></div>
                </div>
                        
            </div>
        </div>
        
        <div class="col-lg-2 col-md-2 col-sm-3 col-xs-4 col">
            <div class="panel panel-default panelparam">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-xs-3 col-small">
                            <img src='@Url.Content("~/img/params_icon/water.gif")' style="position: absolute"/>
                        </div>
                        <div class="col-xs-9 col-small text-right">
                            <div class="huge">{{lastData().WaterCalculated.toFixed(3)}}</div>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <span class="text-muted">Расх. воды общ., м<sup>3</sup></span>
                    <div class="clearfix"></div>
                </div>
                        
            </div>
        </div>
        
        <div class="col-lg-2 col-md-2 col-sm-3 col-xs-4 col">
            <div class="panel panel-primary panelparam">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-xs-3 col-small">
                            <img src='@Url.Content("~/img/params_icon/press.gif")' style="position: absolute; height:25px"/>
                        </div>
                        <div class="col-xs-9 col-small text-right">
                            <div class="huge">{{lastData().Presure.toFixed(2)}}</div>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <span class="text-muted">Давление, МПа</span>
                    <div class="clearfix"></div>
                </div>
                        
            </div>
        </div>
        
        <div class="col-lg-2 col-md-2 col-sm-3 col-xs-4 col">
            <div class="panel panel-info panelparam">
                <div class="panel-heading">
                    <div class="row">
                        <div class="col-xs-3 col-small">
                            <img src='@Url.Content("~/img/params_icon/tok.gif")' style="position: absolute; width: 85px" />
                        </div>
                        <div class="col-xs-9 col-small text-right">
                            <span class="huge">{{lastData().EngineAmp.toFixed(3)}}</span>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <span class="text-muted">Ток<sub>дв</sub>, А</span>
                    <div class="clearfix"></div>
                </div>

            </div>
        </div>

    </div>
    <div class="row">
        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
            <blockquote class="errors" data-ng-show="lastData().Errors.length>0">
                <p class="text-danger">{{lastData().Errors}}</p>
            </blockquote>

        </div>
    </div>
    <div class="row">
        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
            <a href='@Url.Action("EditWaterPumpParams", "Water", new { identity = Model.Identity, ReturnUrl = Request.RawUrl })' target="_self" class="btn btn-sm btn-default pull-right"><span class="glyphicon glyphicon-wrench">&nbsp;</span>Начальные параметры счетчика воды</a>
            <a href='@Url.Action("ViewPumpParams", "Water", new { identity = Model.Identity, ReturnUrl = Request.RawUrl })' target="_self" class="btn btn-sm btn-default pull-right"><span class="glyphicon glyphicon-indent-right">&nbsp;</span>Номинальные параметры насоса</a>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6 col-md-offset-3 col-sm-8 col-sm-offset-2 col-xs-12">
            <div class="text-muted text-center"><h5>Рассчитанные параметры</h5></div>
            
            <table id="calculatedTable" class="table table-bordered">
                <tr>
                    <td title="Рассчитывается на основе потребления за последние 10 мин">Мгновенный расход воды, м<sup>3</sup>/ч</td>
                    <td>{{WaterByHour().toFixed(4)}}</td>
                </tr>
                <tr>
                    <td title="Рассчитывается на основе отношения общего расхода электроэнергии к общему расходу воды">Уд. расход эл. энергии, кВт.ч/м<sup>3</sup></td>
                    <td>{{lastData().WaterEnergy.toFixed(3)}}</td>
                </tr>
            </table>
            
        </div>
    </div>
    <div class="row">
        <div class="col-md-12 col-xs-12 col-sm-12 text-center">
            <div id="warning_msg" data-ng-show="loseDataTime()>1">
    Внимание! С момента получения последних данных прошло более {{loseDataTime().toFixed(1)}} мин.<br/> Вероятно последние значения не актуальны...
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-5 col-md-5 col-sm-6 col-xs-6">
            <h2 class="text-right text-muted" style="margin-top:0px">
                График показаний
            </h2>
        </div>
        <div class="col-lg-4 col-md-5 col-sm-6 col-xs-6">
            <select data-ng-model="graphParam" class="form-control">
                <option value="TotalEnergy" class="text-danger">Эл энергия</option>
                <option value="Amperage1" class="text-primary">Ток фаза 1</option>
                <option value="Amperage2" class="text-primary">Ток фаза 2</option>
                <option value="Amperage3" class="text-primary">Ток фаза 3</option>
                <option value="Voltage1" class="text-warning">Напряжение фаза 1</option>
                <option value="Voltage2" class="text-warning">Напряжение фаза 2</option>
                <option value="Voltage3" class="text-warning">Напряжение фаза 3</option>
                <option value="Frequrency" class="text-info">Частота</option>
                <option value="Presure" class="text-info">Давление</option>
                <option value="CurrentElectricPower" class="text-danger">Мощность</option>
                <option value="Temperature" class="text-danger">Температура</option>
                <option value="WaterEnergy" class="text-success">Удельн. расх. элект.</option>
                <option value="EngineAmp" class="text-primary">Ток мотора</option>
            </select>
        </div>
            

    </div>
    
    
    <div class="row">
        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
            <div>
                <svg id="AmperageGraph" style="border:1px dashed gray"></svg>
                
            </div>

        </div>
      
    </div>
    
    <div class="row">
        <div class="col-lg-10 col-md-9 col-sm-8 col-xs-8">
            <h2 class="text-center text-muted">
                Значения за последние 30 мин
            </h2>
            
        </div>
        <div class="col-lg-2 col-md-3 col-sm-4 col-xs-4" >
            <a class="btn btn-default btn-sm" style="margin-top: 15px; margin-bottom: 5px" href='@Url.Action("History", "History", new {id=Model.MarkerId})'><span class="glyphicon glyphicon-calendar"></span>&nbsp;История показаний</a>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
            <div class="well">
                <div class="row">
                    <div class="col-md-6">
                        <b>Предельные отклонения:</b>
                    </div>
                </div>
                <div class="row" style="padding: 5px 5px">


                    <div class="col-lg-3 col-md-3 col-sm-3 col-xs-6" style="padding: 0 10px;">
                        <span class="inpt-label" title="Диапазон корректных значений тока">I<sub>min-max</sub>=</span>
                        <input type="text" data-ng-model="Ilimit.min" size="3" />-<input type="text" data-ng-model="Ilimit.max" size="3" />
                    </div>

                    <div class="col-lg-3 col-md-3 col-sm-3 col-xs-6" style="padding:0 10px;">
                        <span class="inpt-label" title="Диапазон корректных значений напряжения">U<sub>min-max</sub>=</span>
                        <input type="text" data-ng-model="Ulimit.min" size="4" />-<input type="text" data-ng-model="Ulimit.max" size="4" />
                    </div>

                    <div class="col-lg-3 col-md-3 col-sm-3 col-xs-6" style="padding: 0 10px;">
                        <span class="inpt-label" title="Диапазон корректных значений мощности">W<sub>min-max</sub>=</span>
                        <input type="text" data-ng-model="Wlimit.min" size="4" />-<input type="text" data-ng-model="Wlimit.max" size="4" />
                    </div>

                    <div class="col-lg-3 col-md-3 col-sm-3 col-xs-6" style="padding: 0 10px;">
                        <span class="inpt-label" title="Диапазон корректных значений давления">P<sub>min-max</sub>=</span>
                        <input type="text" data-ng-model="Plimit.min" size="4" />-<input type="text" data-ng-model="Plimit.max" size="4" />
                    </div>
                </div>
            </div>
                <div class="row">
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <table id="detailTableParameters" class="table table-condensed table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th rowspan="2">
                                        Дата/время
                                    </th>
                                    <th rowspan="2">
                                        Энер Q, <span class="ed">кВтч</span>
                                    </th>

                                    <th rowspan="2">+/-</th>
                                    <th rowspan="2">
                                        Уд эл, <span class="ed">кВтч/м<sup>3</sup></span>
                                    </th>
                                    <th rowspan="2">
                                        Вода V, <span class="ed">м<sup>3</sup></span>
                                    </th>
                                    <th rowspan="2">+/-</th>
                                    <th colspan="3" style="text-align: center">
                                        Ток, <span class="ed">А</span>
                                    </th>

                                    <th colspan="3" style="text-align: center">
                                        Напр, <span class="ed">В</span>
                                    </th>

                                    <th rowspan="2">
                                        Част v, <span class="ed">Гц</span>
                                    </th>

                                    <th rowspan="2">
                                        Мощн W, <span class="ed">кВт</span>
                                    </th>

                                    <th rowspan="2">
                                        Давл P, <span class="ed">МПа</span>
                                    </th>
                                    <th rowspan="2">
                                        Ток дв, <span class="ed">А</span>
                                    </th>
                                    <th rowspan="2">
                                        Темп Т, <span class="ed">°С</span>
                                    </th>
                                    <th rowspan="2">
                                        !
                                    </th>
                                </tr>
                                <tr>
                                    <th>I<sub>1</sub></th>
                                    <th>I<sub>2</sub></th>
                                    <th>I<sub>3</sub></th>
                                    <th>U<sub>1</sub></th>
                                    <th>U<sub>2</sub></th>
                                    <th>U<sub>3</sub></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr data-ng-repeat="elem in EWdata.data">
                                    <td class="text-success" style="font-size:10px">{{ elem.RecvDate.toLocaleString('ru-RU',{day:'numeric', month:'numeric', year:'numeric', hour:'numeric', minute:'numeric', second:'numeric',timeZone:'Europe/Minsk'}) }}</td>
                                    <td title="{{elem.TotalEnergy}}">{{ elem.TotalEnergy.toFixed(3) }}</td>
                                    <td class="text-muted">+{{ EWdata.data.length>$index+1?(elem.TotalEnergy-EWdata.data[$index+1].TotalEnergy).toFixed(5):null }}</td>
                                    <td>{{ elem.WaterEnergy.toFixed(3) }}</td>
                                    <td title="{{elem.TotalWaterRate}}">{{ elem.WaterCalculated.toFixed(2) }}</td>
                                    <td class="text-muted">+{{ EWdata.data.length>$index+1?(elem.WaterCalculated-EWdata.data[$index+1].WaterCalculated).toFixed(3):null }}</td>
                                    <td style="border-left:2px solid lightgray"><span data-ng-class="IclassLimit(elem.Amperage1,Ilimit)">{{ elem.Amperage1.toFixed(3) }}</span></td>
                                    <td><span data-ng-class="IclassLimit(elem.Amperage2,Ilimit)">{{ elem.Amperage2.toFixed(3) }}</span></td>
                                    <td><span data-ng-class="IclassLimit(elem.Amperage3,Ilimit)">{{ elem.Amperage3.toFixed(3) }}</span></td>
                                    <td style="border-left:2px solid lightgray"><span data-ng-class="IclassLimit(elem.Voltage1,Ulimit)">{{ elem.Voltage1.toFixed(1) }}</span></td>
                                    <td><span data-ng-class="IclassLimit(elem.Voltage2,Ulimit)">{{ elem.Voltage2.toFixed(1) }}</span></td>
                                    <td><span data-ng-class="IclassLimit(elem.Voltage3,Ulimit)">{{ elem.Voltage3.toFixed(1) }}</span></td>
                                    <td style="border-left:2px solid lightgray" class="text-muted">{{ elem.Frequrency.toFixed(1)  }}</td>
                                    <td><span data-ng-class="IclassLimit(elem.CurrentElectricPower,Wlimit)">{{ elem.CurrentElectricPower.toFixed(3)  }}</span></td>
                                    <td><span data-ng-class="IclassLimit(elem.Presure,Plimit)">{{ elem.Presure.toFixed(3) }}</span></td>
                                    <td>{{ elem.EngineAmp.toFixed(3)  }}</td>
                                    <td>{{ elem.Temperature.toFixed(1)  }}</td>
                                    <td title="Список ошибок счетчика: {{elem.Errors}}" data-ng-class="getClassRowError(elem.Errors)"><span data-ng-if="elem.Errors.length>0"><img src='@Url.Content("~/img/error_icon.png")' height="20" /></span></td>

                                </tr>
                            </tbody>
                            <tfoot style="font-weight:bold">
                                <tr>
                                    <td>{{intervalData()}}</td>
                                    <td style="text-align: right">всего:</td>
                                    <td>{{EnergyRate().toFixed(3)}}</td>
                                    <td></td>
                                    <td style="text-align: right">всего:</td>
                                    <td>{{WaterRate().toFixed(3)}}</td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                



            </div>
    </div>
    
        
</div>

@section Scripts {
    
    <script type="text/javascript" src='@Url.Content("~/js/angular/angular.min.js")'></script>
    <script type="text/javascript" src='@Url.Content("~/js/d3/d3.v3.min.js")'></script>

    <script type="text/javascript">
        moment.locale('ru');
    </script>
    @Scripts.Render("~/unicomVisual")
    
   
  
}
